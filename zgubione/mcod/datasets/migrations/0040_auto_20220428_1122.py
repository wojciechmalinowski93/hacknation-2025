# Generated by Django 2.2.9 on 2022-04-28 09:22

from django.db import migrations
from django.db.models import Q, F


def set_new_condition(apps, schema_editor):
    Dataset = apps.get_model("datasets", "Dataset")
    custom_descr_q = ~Q(license_condition_responsibilities="") & Q(license_condition_responsibilities__isnull=False)
    objs = Dataset.objects.filter(
        Q(license_condition_source=True)
        | Q(license_condition_modification=True)
        | Q(license_condition_cc40_responsibilities=True)
        | custom_descr_q
    ).distinct()
    objs.update(license_condition_default_cc40=True)
    custom_descr_objs = Dataset.objects.filter(custom_descr_q)
    custom_descr_objs.update(license_condition_custom_description=F("license_condition_responsibilities"))


def unset_new_conditions(apps, schema_editor):
    Dataset = apps.get_model("datasets", "Dataset")
    Dataset.objects.filter(license_condition_default_cc40=True).update(license_condition_default_cc40=False)
    custom_descr_q = ~Q(license_condition_custom_description="") & Q(license_condition_custom_description__isnull=False)
    Dataset.objects.filter(custom_descr_q).update(license_condition_custom_description=None)


class Migration(migrations.Migration):

    dependencies = [
        ("datasets", "0039_auto_20220428_1122"),
    ]

    operations = [
        migrations.RunPython(set_new_condition, reverse_code=unset_new_conditions),
    ]
